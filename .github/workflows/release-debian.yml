name: Build Debian Package

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: ubuntu-24.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Assemble package tree
        env:
          VERSION: ${{ steps.version.outputs.version }}
        run: |
          PKG="markforge_${VERSION}_all"

          install -d "${PKG}/DEBIAN"
          install -d "${PKG}/usr/bin"
          install -d "${PKG}/usr/lib/markforge"
          install -d "${PKG}/usr/share/applications"
          install -d "${PKG}/usr/share/pixmaps"

          install -m 644 src/*.py "${PKG}/usr/lib/markforge/"

          printf '#!/bin/sh\nexec python3 /usr/lib/markforge/main.py "$@"\n' \
            > "${PKG}/usr/bin/markforge"
          chmod 755 "${PKG}/usr/bin/markforge"

          install -m 644 build/linux/markforge.desktop \
            "${PKG}/usr/share/applications/"

          install -m 644 assets/markforge.svg \
            "${PKG}/usr/share/pixmaps/markforge.svg"

          sed "s/@VERSION@/${VERSION}/g" build/linux/control.in \
            > "${PKG}/DEBIAN/control"

          dpkg-deb --build --root-owner-group "${PKG}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: markforge-deb
          path: markforge_*.deb
          if-no-files-found: error

      - name: Upload release asset
        uses: softprops/action-gh-release@v2
        with:
          files: markforge_*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
